# SSL/TLS握手

## 加密算法

加密算法可以分为对称加密和非对称加密。两种加密方法的区别是是否使用同一种密钥

* 对称加密

采用单密钥密码系统的加密方法，使用同一个密钥作为信息的加密和解密。对称加密算法又称为单密钥加密。对称加密算法的优点是算法公开、计算量小、加密速度快、效率高，缺点是交易双方使用同样的密钥，安全性得不到保证。

常用的对称加密有DES、AES等。

* 非对称加密

非对称加密使用一对私有密钥(Private Key)和公开密钥(Public Key)。 使用私有密钥加密的信息，只能使用公开密钥解密； 使用公开密钥加密的信息，只能使用私有密钥解密。由于非对称加密不需要共享一个密钥，因此安全性更高，但是非对称加密算法更复杂、加密解密速度较慢，适合用于少部分的信息。

常见的非对称加密有 RSA、ESA、ECC 等。

## 数字签名和数字证书

* 摘要算法

摘要算法的原理是根据一定的运算规则对原数据进行提取，这种提取被称为摘要。提取出的结果和原数据密切相关，因此当原数据被篡改的时候，使用摘要算法获得的结果会完全不同。因此使用摘用算法来对数据的完整性提供较为健全的保障。

摘要算法是不可逆的，不能反向推断出原数据内容。因此只能作为数据完整性检验。摘要算法还应具备强碰撞性的特点，即在已知原数据和摘要结果数据的情况下，难以通过修改原数据生成相同的摘要结果。

常见的摘要算法有MD5、SHA等。

* 数字签名 digital signature

数字签名是非对称密钥加密技术与数字摘要技术的应用。即使用摘要算法提取出原数据的摘要并使用密钥进行加密。主要用于保障数据的完整性和认证发送者的身份。

* 数字证书 digital certificate

数字证书是一个经证书授权中心数字签名的包含公开密钥拥有者信息以及公开密钥的文件。数字证书里一般会包含公钥、公钥拥有者名称、CA 的数字签名、有效期、授权中心名称、证书序列号等信息。

## SSL/TLS

SSL/TLS和HTTP一样都是应用层的协议，在HTTPS中，主要由SSL/TLS对HTTP进行加密。SSL/TLS 协议主要采用的是公钥加密，客户端先向服务索要公钥，然后使用公钥加密信息，服务器接收到加密信息后使用私钥进行解密。

目前，应用最广泛的是TLS 1.0，接下来是SSL 3.0。但是，主流浏览器都已经实现了TLS 1.2的支持。

TLS 1.0通常被标示为SSL 3.1，TLS 1.1为SSL 3.2，TLS 1.2为SSL 3.3。

### SSL/TLS握手

SSL/TSL握手是服务器和客户端协商生成对称加密的密钥的过程。对每一次对话(session)，客户端和服务器都生成一个对话密钥(session key)，对话密钥是对称加密所使用的密钥。公钥则用于加密对话密钥本身。这样就可以大大减少计算时间。

* 客户端发出请求 ClientHello

客户端(浏览器)向服务器发出加密通信的请求。请求中会提供以下信息：

	*　客户端支持的协议版本
	* 一个客户端生成的随机数，用于之后生成对话密钥
	* 客户端支持的加密方法 Support Ciphers
	* 支持的压缩方法

* 服务器响应 SeverHello

服务器在接收到客户端的请求后会做出响应。响应中会提供以下信息：

	* 确认使用的加密通信协议版本(如TLS1.0)
	* 一个客户端生成的随机数，用于之后生成对话密钥
	* 根据客户端的Support Ciphers，确认使用的加密方法
	* 服务器的证书

如果服务器要确认客户端的身份，会再包含一项请求，要求客户端提供"客户端证书"。

* 客户端响应

客户端受到服务器响应后，首先会验证服务器证书。假如证书不可信(并非由可信机构颁布， 或者证书中的域名和实际域名不一致， 或者证书已经过期)，则会向访问者显示警告，由访问者决定是否继续访问。

假如证书可信，客户端会从证书中取出服务器的公钥，然后向服务器发送以下信息：

	* 一个随机数，用户服务器公钥加密，防止被窃听("pre-master key")
	* 编码改变通知。表示之后的信息使用双方商定的加密方法和密钥发送
	* 客户端握手结束通知。同时也是前面发送的所有内容的hash值，用于供服务器校验

假如此前服务器要求客户端提供客户端证书，客户端会在这一步发送证书及相关信息。

* 服务器的最后响应

服务器使用三个随机数，通过密钥导出器最后导出一个对称密钥，作为本次会话使用的"会话密钥"。然后向客户端最后发送下面的信息：

	* 编码改变通知
	* 服务器握手结束通知。同时也是前面发送的所有内容的hash值，用于供客户端校验

在该步骤结束之后，整个握手阶段全部结束。之后客户端与服务器将使用HTTP协议进行加密通信，使用"会话密钥"加密通信内容。

### 握手过程的优化

在ClientHello消息中，会附带上一次会话的Session ID，服务器可以对该Session ID进行验证。 假如可以复用，则不再进行后续的握手过程。

除了上述的 Session 复用，SSL/TLS 握手还有一些优化技术，例如False Start、Session Ticket等。